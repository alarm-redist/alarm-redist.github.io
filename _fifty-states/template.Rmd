---
title: "`r paste0(params$state, ' Congressional Districts')`"
params:
    slug: IA_cd_2020
    state: Iowa
output:
  distill::distill_article:
    self_contained: false
repository_url: https://github.com/alarm-redist/fifty-states/
---

    ```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,warning = FALSE, message = FALSE)
library(redist)
library(tidyverse)
library(scales)
library(patchwork)
library(dataverse)
ggplot2::theme_set(ggplot2::theme_bw())
doi <- '10.7910/DVN/SLCD3E'
```

```{r colors, include = FALSE, results = 'hide'}
GOP_DEM <- c("#A0442C", "#B25D4C", "#C27568", "#D18E84", "#DFA8A0",
             "#EBC2BC",  "#F6DCD9", "#F9F9F9", "#DAE2F4", "#BDCCEA",
             "#9FB6DE", "#82A0D2", "#638BC6", "#3D77BB", "#0063B1")
scale_fill_party_c <- function(name="Democratic share", midpoint=0.5, limits=0:1,
                               labels=percent, oob=squish, ...) {
    scale_fill_gradient2(name=name, ..., low = GOP_DEM[1], high = GOP_DEM[15],
                         midpoint=midpoint, limits=limits, labels=labels, oob=oob)
}
scale_color_party_c <- function(name="Democratic share", midpoint=0.5, limits=0:1,
                                labels=percent, oob=squish, ...) {
    scale_color_gradient2(name=name, ..., low = GOP_DEM[1], high = GOP_DEM[15],
                          midpoint=midpoint, limits=limits, labels=labels, oob=oob)
}

scale_color_party_d = function(...) {
    scale_color_manual(..., values=c(GOP_DEM[2], GOP_DEM[14]),
                       labels=c("Rep.", "Dem."))
}
```

```{r data, include = FALSE, results = 'hide'}
files <- dataset_files(doi)
file_names <- map_chr(files, \(x) x$label)

tf <- fs::file_temp(ext = 'rds')
get_file_by_name(filename = file_names[str_detect(file_names, 'map.rds') &
                                           str_detect(file_names,
                                                      params$slug)],
                 dataset = doi,
                 server = "dataverse.harvard.edu") %>%
    writeBin(con = tf)
map <- read_rds(tf)

tf <- fs::file_temp(ext = 'rds')
get_file_by_name(filename = file_names[str_detect(file_names, 'plans.rds') &
                                           str_detect(file_names,
                                                      params$slug)],
                 dataset = doi,
                 server = "dataverse.harvard.edu") %>%
    writeBin(con = tf)
plans <- read_rds(tf)

tf <- fs::file_temp(ext = 'tab')
get_file_by_name(filename = file_names[str_detect(file_names, 'stats.tab') &
                                           str_detect(file_names,
                                                      params$slug)],
                 dataset = doi,
                 server = "dataverse.harvard.edu") %>%
    writeBin(con = tf)
sum_stat <- read_csv(tf, show_col_types = FALSE) %>%
    mutate(draw = factor(draw))

plans <- plans %>% left_join(sum_stat, by = c("draw", "district"))

plans <- plans %>% mutate(dvs = group_frac(map, ndv, ndv + nrv))

tf <- fs::file_temp(ext = 'html')
get_file_by_name(filename = file_names[str_detect(file_names, 'doc.html') &
                                           str_detect(file_names,
                                                      params$slug)],
                 dataset = doi,
                 server = "dataverse.harvard.edu")  %>%
    writeBin(con = tf)
htmls <- read_lines(tf)
start <- which(startsWith(htmls, '<p>In '))[1]
end <- which(htmls == '<h2 id="contents">Contents</h2>') - 1
tf <- fs::file_temp(ext = 'html')
write_lines(htmls[start:end], tf)
```

## Enacted Plan

```{r enacted}
redist.plot.plans(plans, 'cd', shp = map, qty = dvs) +
    geom_sf(data = map %>% group_by(cd) %>%
                summarize(geometry = sf::st_union(geometry)), fill = NA, lwd = 2) +
    scale_fill_party_c() +
    labs(title = '')
```

## Sample Simulated Plans

```{r, warning=FALSE}
redist.plot.plans(plans, sample(1:5000, 3), geom = map, qty = dvs) &
    scale_fill_party_c() &
    guides(fill = 'none')
```

## Expected Partisanship

```{r}
redist.plot.distr_qtys(plans, dvs, color_thresh = 0.5) +
    scale_color_party_d()
```

## Partisan Bias

```{r}
{redist.plot.hist(plans, pbias) + labs(x = 'Partisan Bias')} +
    {redist.plot.hist(plans, egap)  + labs(x = 'Efficiency Gap')}
```


## Compactness

```{r}
redist.plot.distr_qtys(plans, comp_polsby, geom = 'boxplot') +
    labs(y = "Polsby Popper",
         x = 'Ordered District, by Polsby Popper')
```

## Simulation Notes

````{=html}
```{r, echo=FALSE, results='asis'}
xfun::file_string(tf)
```
````



# Download the Data

[Download](https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/SLCD3E)
