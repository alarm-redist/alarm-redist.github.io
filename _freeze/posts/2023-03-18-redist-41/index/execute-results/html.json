{
  "hash": "eda500a4cdd0cb5fe61a71c65f96eab3",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"redist 4.1\"\ndescription: |\n  A medium-sized release with more flexible plotting, better diagnostics, and\n  speed improvements.\nauthor:\n  - name: Christopher T. Kenny\n    affiliation: Department of Government, Harvard University \n    url: https://www.christophertkenny.com/\n  - name: Cory McCartan\n    affiliation: Department of Statistics, Harvard University\n    url: https://www.corymccartan.com\ndate: 2023-03-19\n---\n\n\n\n\n\n\n\nIt's been a while since [`redist` 4.0](https://alarm-redist.org/posts/2022-06-20-redist-40/) was released and things have been fairly stable. Most of the changes in this release are behind-the-scenes improvements that shouldn't break your workflow, but should improve your experience using the package.\n\nTo install version 4.1, get the new version from CRAN:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninstall.packages('redist')\n```\n:::\n\n\n\n\n# New Features\n\n- Extends the ordered `box`/`jitter` plots to custom ordered geometries in `redist.plot.distr_qtys()`\n\n- Better diagnostic outputs for `summary.redist_plans()`\n\n- Improved confidence intervals with `redist_ci()`\n\n- C++ improvements for sampling more quickly\n    - Better sampling efficiency in SMC's final stage\n    - Quicker random walks for SMC and merge-split.\n    - Faster random number generation. (It's small, but it adds up!)\n\n# Plotting Flexibility with `redist.plot.distr_qtys()`\n\nBox-and-whiskers plots are great and useful in many situations. In redistricting, we've often used ordered boxplots. These order the x-axis by the quantity on the x-axis. Sometimes, a boxplot throws away information that you might care about, though. \n>Is the distribution multi-modal? Where are the 2.5th and 97.5th percentiles for a confidence interval? \n\nNow, you can take those questions into your own hands with adjustments to arguments in `redist.plot.distr_qtys()`!\n\nLet's build this out a bit. First, we'll use some data from the [50-State Redistricting Simulations](https://alarm-redist.org/posts/2022-11-01-50statessimulations/) via the [`alarmdata`](https://alarm-redist.org/alarmdata/) package.\n\nWe can get the `redist_map` and corresponding 5,000 sampled plus the enacted plans in a `redist_plans` object for Michigan.  \n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(dplyr)\nlibrary(redist)\nlibrary(alarmdata)\nmap <- alarm_50state_map('MI')\nplans <- alarm_50state_plans('MI')\n```\n:::\n\n\n\n\n`plans` here has a column `e_dvs` that gives the expected Democratic vote share for each district in each plan.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nredist.plot.distr_qtys(plans, qty = e_dvs)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n\n\nWe've always been able to clean or augment this plot up using regular `ggplot2` things:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggplot2)\n\nredist.plot.distr_qtys(plans, qty = e_dvs) + \n    geom_hline(yintercept = 0.5, linetype = 'dotted') + \n    scale_y_continuous(name = 'Expected Dem. Vote Share', labels = scales::label_percent(), \n                       limits = c(0.25, 0.95), breaks = seq(0.2, 0.9, by = 0.1)) +\n    theme_bw()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n\nYou can draw clear conclusions here, like that districts 2, 3, and 4 are abnormally packed with Republicans compared to what we might normally see when drawing districts that follow the state's redistricting rules. We might not be able to get all of the information out of this plot that we want, beyond which districts are _clear_ outliers.\n\nNow, if we made it a box plot instead of a jitter plot, as the points can be overwhelming, we can still draw the same major conclusions, and we now have a more formal idea of outliers that don't just sit above or below the data. Things like district 6 can be still be a bit unclear. Is district 6 in the outlier range or are the points just big on this small plot? \n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nredist.plot.distr_qtys(plans, qty = e_dvs, geom = 'boxplot') + \n    geom_hline(yintercept = 0.5, linetype = 'dotted') + \n    scale_y_continuous(name = 'Expected Dem. Vote Share', labels = scales::label_percent(), \n                       limits = c(0.25, 0.95), breaks = seq(0.2, 0.9, by = 0.1)) +\n    theme_bw()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n\n\nA first thing we might consider doing is to use a violin plot instead of a boxplot, as that doesn't summarize distributional information in the same way as a box plot. This is now really easy, just pass `ggplot2::geom_violin` as an argument to geom.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nredist.plot.distr_qtys(plans, qty = e_dvs, geom = ggplot2::geom_violin) + \n    geom_hline(yintercept = 0.5, linetype = 'dotted') + \n    scale_y_continuous(name = 'Expected Dem. Vote Share', labels = scales::label_percent(), \n                       limits = c(0.25, 0.95), breaks = seq(0.2, 0.9, by = 0.1)) +\n    theme_bw()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n\nThe defaults here don't always play the best though, so we might want to also change the reference geometry.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nr_geom <- function(...) \n    ggplot2::geom_segment(\n        ggplot2::aes(x = as.integer(.distr_no) - 0.5,\n                     xend = as.integer(.distr_no) + 0.5,\n                     yend = e_dvs,\n                     color = .data$draw),\n        ...\n    )\n```\n:::\n\n\n\n\nThis immediately gets a bit more complicated. For this to work, we need to know a few things:\n\n1. The function has to take `...` as an argument. \n2. Internally, the variable we are plotting on the x is going to be called `.distr_no`.\n3. The reference geometry will inherit `x = .distr_no` by default and `y = qty`, for whatever your input to `qty` is.\n\nThe above then says, on the x-axis, we want a line from the district - 0.5 to the district + 0.5, while we set `yend = e_dvs` to match the implicitly set `y = e_dvs`, since we passed `qty = e_dvs` before.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nredist.plot.distr_qtys(plans, qty = e_dvs, geom = ggplot2::geom_violin, ref_geom = r_geom) + \n    geom_hline(yintercept = 0.5, linetype = 'dotted') + \n    scale_y_continuous(name = 'Expected Dem. Vote Share', labels = scales::label_percent(), \n                       limits = c(0.25, 0.95), breaks = seq(0.2, 0.9, by = 0.1)) +\n    theme_bw()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n\n\nThe good thing here is that we can adjust the `ref_geom` however we see fit at this point. So if that red line is _too_ dark, but also too skinny, we can do something like changing the `alpha`:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nr_geom <- function(...) \n    ggplot2::geom_segment(\n        ggplot2::aes(x = as.integer(.distr_no) - 0.5,\n                     xend = as.integer(.distr_no) + 0.5,\n                     yend = e_dvs,\n                     color = .data$draw),\n        linewidth = 1, alpha = 0.7,\n        ...\n    )\n```\n:::\n\n\n\n\nThen this fixes those particular issues.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nredist.plot.distr_qtys(plans, qty = e_dvs, geom = ggplot2::geom_violin, ref_geom = r_geom) + \n    geom_hline(yintercept = 0.5, linetype = 'dotted') + \n    scale_y_continuous(name = 'Expected Dem. Vote Share', labels = scales::label_percent(), \n                       limits = c(0.25, 0.95), breaks = seq(0.2, 0.9, by = 0.1)) +\n    theme_bw()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\n\n\n\nNow, there are tons of other things we can do here. If we want to revisit the 95% confidence interval issue, we can turn to `ggdist`.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggdist)\n\nredist.plot.distr_qtys(plans, qty = e_dvs, geom = stat_pointinterval, ref_geom = r_geom) + \n    geom_hline(yintercept = 0.5, linetype = 'dotted') + \n    scale_y_continuous(name = 'Expected Dem. Vote Share', labels = scales::label_percent(), \n                       limits = c(0.25, 0.95), breaks = seq(0.2, 0.9, by = 0.1)) +\n    theme_bw()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n\n\n\nNow, we have really clear idea of how wide the 95% confidence interval goes (via the length of the skinny lines).\n\n\nAnd really, the sky is the limit with packages like `ggdist`. For example, if we want a `raincloud`, we can do that.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nraincloud <- function(...) {\n    list(\n        ggdist::stat_slab(aes(thickness = ggplot2::after_stat(pdf*n)), scale = 1),\n        ggdist::stat_dotsinterval(side = \"bottom\", scale = 1,\n                                  slab_size = NA, quantiles = 100)\n    )\n}\n```\n:::\n\n\n\n\nThis gives us a fun plot to work with, though this might be best suited for much larger plot areas.\n\n\n\n\n::: {.cell preview='true'}\n\n```{.r .cell-code}\nredist.plot.distr_qtys(plans, qty = e_dvs, geom = raincloud, ref_geom = r_geom) + \n    geom_hline(yintercept = 0.5, linetype = 'dotted') + \n    scale_y_continuous(name = 'Expected Dem. Vote Share', labels = scales::label_percent(), \n                       limits = c(0.35, 0.95), breaks = seq(0.2, 0.9, by = 0.1)) +\n    theme_bw()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n:::\n\n\n\n\n# Better Diagnostics for `summary.redist_plans()`\n\nLike above, let's get some simulated plans from the [50-State Redistricting Simulations](https://alarm-redist.org/posts/2022-11-01-50statessimulations/). We can get a state like Nevada, which has fewer districts and shorter summary.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(alarmdata)\nplans <- alarm_50state_plans('NV')\n```\n:::\n\n\n\n\nTo get diagnostics, we can call `summary(plans)` which computes R-hats, sample diversity, and some split-by-split SMC diagnostics.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(plans)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nSMC: 5,000 sampled plans of 4 districts on 2,102 units\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n`adapt_k_thresh`=0.985 • `seq_alpha`=0.5\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n`pop_temper`=0\n```\n\n\n:::\n\n\n::: {.cell-output .cell-output-stderr}\n\n```\nPlan diversity 80% range: 0.55 to 0.74\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nR-hat values for summary statistics:\n   pop_overlap      total_vap       plan_dev      comp_edge    comp_polsby \n         1.003          1.003          1.001          1.000          1.000 \n      pop_hisp      pop_white      pop_black       pop_aian      pop_asian \n         1.009          1.005          1.003          1.002          1.003 \n      pop_nhpi      pop_other        pop_two       vap_hisp      vap_white \n         1.000          1.003          1.003          1.007          1.006 \n     vap_black       vap_aian      vap_asian       vap_nhpi      vap_other \n         1.004          1.001          1.002          1.000          1.007 \n       vap_two pre_16_dem_cli pre_16_rep_tru uss_16_dem_cor uss_16_rep_hec \n         1.003          1.001          1.003          1.000          1.004 \nuss_18_dem_ros uss_18_rep_hel gov_18_dem_sis gov_18_rep_lax atg_18_dem_for \n         1.002          1.002          1.002          1.003          1.001 \natg_18_rep_dun sos_18_dem_ara sos_18_rep_ceg pre_20_dem_bid pre_20_rep_tru \n         1.002          1.001          1.003          1.002          1.004 \n        arv_16         adv_16         arv_18         adv_18         arv_20 \n         1.003          1.000          1.003          1.002          1.004 \n        adv_20  county_splits    muni_splits            ndv            nrv \n         1.002          1.002          1.003          1.002          1.003 \n       ndshare          e_dvs         pr_dem          e_dem          pbias \n         1.003          1.003          1.001          1.002          1.000 \n          egap \n         1.001 \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nSampling diagnostics for SMC run 1 of 2 (2,500 samples)\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n         Eff. samples (%) Acc. rate Log wgt. sd  Max. unique Est. k \nSplit 1     2,215 (88.6%)     19.7%        0.93 1,583 (100%)     10 \nSplit 2     2,287 (91.5%)     12.8%        0.51 1,565 ( 99%)      6 \nSplit 3     2,242 (89.7%)      5.9%        0.56 1,441 ( 91%)      4 \nResample    1,352 (54.1%)       NA%        0.57 1,409 ( 89%)     NA \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nSampling diagnostics for SMC run 2 of 2 (2,500 samples)\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n         Eff. samples (%) Acc. rate Log wgt. sd  Max. unique Est. k \nSplit 1     2,228 (89.1%)     15.1%        0.91 1,584 (100%)     13 \nSplit 2     2,285 (91.4%)      9.7%        0.52 1,574 (100%)      8 \nSplit 3     2,236 (89.4%)      5.0%        0.58 1,444 ( 91%)      5 \nResample    1,471 (58.8%)       NA%        0.59 1,399 ( 89%)     NA \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n• Watch out for low effective samples, very low acceptance rates (less than\n1%), large std. devs. of the log weights (more than 3 or so), and low numbers\nof unique plans. R-hat values for summary statistics should be between 1 and\n1.05.\n```\n\n\n:::\n:::\n\n\n\nThe first big change here is that the digits are now rounded to three digits. \nYou no longer need to search through 8 decimal digits at 3am for the ones that matter.\n\nTypically, we want R-hat values between 1 and 1.05, so this looks pretty good.\nWhat if they weren't? We can introduce this behavior by adding some new variable with very different values by independent run of SMC (denoted by the `chain` column).\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplans <- plans %>% \n    mutate(bad_rhat = rnorm(n = n(), mean = dplyr::coalesce(chain, 0)))\n```\n:::\n\n\n\n\nNow this gets angry:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(plans)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nSMC: 5,000 sampled plans of 4 districts on 2,102 units\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n`adapt_k_thresh`=0.985 • `seq_alpha`=0.5\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n`pop_temper`=0\n```\n\n\n:::\n\n\n::: {.cell-output .cell-output-stderr}\n\n```\nPlan diversity 80% range: 0.55 to 0.75\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nR-hat values for summary statistics:\n   pop_overlap      total_vap       plan_dev      comp_edge    comp_polsby \n         1.003          1.003          1.001          1.000          1.000 \n      pop_hisp      pop_white      pop_black       pop_aian      pop_asian \n         1.009          1.005          1.003          1.002          1.003 \n      pop_nhpi      pop_other        pop_two       vap_hisp      vap_white \n         1.000          1.003          1.003          1.007          1.006 \n     vap_black       vap_aian      vap_asian       vap_nhpi      vap_other \n         1.004          1.001          1.002          1.000          1.007 \n       vap_two pre_16_dem_cli pre_16_rep_tru uss_16_dem_cor uss_16_rep_hec \n         1.003          1.001          1.003          1.000          1.004 \nuss_18_dem_ros uss_18_rep_hel gov_18_dem_sis gov_18_rep_lax atg_18_dem_for \n         1.002          1.002          1.002          1.003          1.001 \natg_18_rep_dun sos_18_dem_ara sos_18_rep_ceg pre_20_dem_bid pre_20_rep_tru \n         1.002          1.001          1.003          1.002          1.004 \n        arv_16         adv_16         arv_18         adv_18         arv_20 \n         1.003          1.000          1.003          1.002          1.004 \n        adv_20  county_splits    muni_splits            ndv            nrv \n         1.002          1.002          1.003          1.002          1.003 \n       ndshare          e_dvs         pr_dem          e_dem          pbias \n         1.003          1.003          1.001          1.002          1.000 \n          egap       bad_rhat \n         1.001        ❌1.233 \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n✖ WARNING: SMC runs have not converged.\n```\n\n\n:::\n\n\n::: {.cell-output .cell-output-stderr}\n\n```\nSampling diagnostics for SMC run 1 of 2 (2,500 samples)\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n         Eff. samples (%) Acc. rate Log wgt. sd  Max. unique Est. k \nSplit 1     2,215 (88.6%)     19.7%        0.93 1,583 (100%)     10 \nSplit 2     2,287 (91.5%)     12.8%        0.51 1,565 ( 99%)      6 \nSplit 3     2,242 (89.7%)      5.9%        0.56 1,441 ( 91%)      4 \nResample    1,352 (54.1%)       NA%        0.57 1,409 ( 89%)     NA \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nSampling diagnostics for SMC run 2 of 2 (2,500 samples)\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n         Eff. samples (%) Acc. rate Log wgt. sd  Max. unique Est. k \nSplit 1     2,228 (89.1%)     15.1%        0.91 1,584 (100%)     13 \nSplit 2     2,285 (91.4%)      9.7%        0.52 1,574 (100%)      8 \nSplit 3     2,236 (89.4%)      5.0%        0.58 1,444 ( 91%)      5 \nResample    1,471 (58.8%)       NA%        0.59 1,399 ( 89%)     NA \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n• Watch out for low effective samples, very low acceptance rates (less than\n1%), large std. devs. of the log weights (more than 3 or so), and low numbers\nof unique plans. R-hat values for summary statistics should be between 1 and\n1.05.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n• SMC convergence: Increase the number of samples. If you are experiencing low\nplan diversity or bottlenecks as well, address those issues first.\n```\n\n\n:::\n:::\n\n\n\nIt warns about convergence, as it has since 4.0. But it now also adds a big red \"x\" next to `bad_rhat`'s R-hat.\n\n\n----\n\nAny questions? [Open an issue on GitHub](https://github.com/alarm-redist/redist/issues) or [find us on Twitter](https://twitter.com/alarm_redist).\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}